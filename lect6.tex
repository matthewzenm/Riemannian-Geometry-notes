\chapter{Bochner Formula and Application}
We state and prove the useful Bochner formula, and apply it on distance function.
We will give another proof of Laplace comparison theorem using Bochner formula, and prove Cheeger--Gromoll splitting theorem.

\section{Bochner Formula}

\begin{thm}[Bochner formula]\index{Bochner formula}
    Let $M$ be a Riemannian manifold, $f\in C^\infty(M)$. Then we have
    \[\Delta\frac{1}{2}|\nabla f|^2=|\nabla^2 f|^2+\langle\nabla\Delta f,\nabla f\rangle+\langle\Ric(\nabla f),\nabla f\rangle.\]
\end{thm}

We first need a lemma.
\begin{lem}\index{Ricci identity!in normal coordinate}
    Under geodesic normal coordinate around $p$, the Ricci identity (Proposition~\ref{Ricci identity}) of $1$-form is equivalent to
    \[f_{;kij}-f_{;kji}=-f_{;l}R^l_{ijk},\]
    where $f_{;i}$ means $\partial_if$.
\end{lem}
\begin{proof}
    First we notice that
    \begin{align*}
        \nabla_{\partial_i}\nabla_{\partial_j}\d{f}&=\nabla_{\partial_i}(\partial_jf_{;k}\d{x^k}+f_{;k}\d{x^k})\\
        &=\partial_i\partial_jf_{;k}\d{x^k}-\nabla_{\partial_i}\Gamma_{jl}^k\d{x^l}\\
        &=f_{;kji}\d{x^k}
    \end{align*}
    since all $\Gamma^k_{jl}=0$ at $p$.
    Then we have
    \begin{align*}
        (R(\partial_i,\partial_j)\d{f})(\partial_k)&=(\nabla_{\partial_j}\nabla_{\partial_i}-\nabla_{\partial_i}\nabla_{\partial_j}+\nabla_{[\partial_i,\partial_j]})\d{f}(\partial_k)\\
        &=(f_{;kij}-f_{;kji}).
    \end{align*}
    On the other hand, we have
    \begin{align*}
        (R(\partial_i,\partial_j)\d{f})(\partial_k)&=-\d{f}(R(\partial_i,\partial_j)\partial_k)\\
        &=-\d{f}(R_{ijk}^l\partial_l)\\
        &=-f_{;m}\d{x^m}(R_{ijk}^l\partial_l)\\
        &=-f_{;l}R_{ijk}^l,
    \end{align*}
    hence the equality holds.
\end{proof}

\begin{proof}[Proof of Bochner formula]
    Under geodesic normal coordinate we have the following calculation
    \begin{align*}
        \Delta\frac{1}{2}|\nabla f|^2&=\sum_{i,j}\left(\frac{1}{2}f^2_{;j}\right)_{;ii}\\
        &=\sum_{i,j}(f_{;j}f_{;ji})_{;i}\\
        &=\sum_{i,j}(f^2_{;ji}+f_{;j}f_{;jii})\\
        &=\sum_{i,j}(f^2_{;ij}+f_{;j}f_{;iji})\quad\text{(Hessian is interchangeable)}\\
        &=\sum_{i,j}f^2_{;ij}+\sum_{i,j}f_{;j}(f_{;iij}-f_{;k}R_{jii}^k)\quad\text{(Ricci identity)}\\
        &=\sum_{i,j}f^2_{;ij}+\sum_{i,j}f_{;j}f_{;iij}+\sum_{i,j}f_{;k}R_{iji}^k\\
        &=\sum_{i,j}f^2_{;ij}+\sum_{i,j}f_{;iij}f_{;j}+\sum_{j}f_{;j}f_{;k}\Ric_j^k\\
        &=|\nabla f|^2+\langle\nabla\Delta f,\nabla f\rangle+\langle\Ric(\nabla f),\nabla f\rangle.\qedhere
    \end{align*}
\end{proof}

As a first application, we use Bochner formula to provide an alternative proof of Bishop's theorem (Theorem~\ref{Bishop}).
\begin{proof}[Alternative proof of Theorem~\ref{Bishop}]
    We apply Bochner formula on distance function $d_p$.
    Notice that $|\nabla d_p|=1$, thus we have
    \[0=|\nabla^2d_p|^2+\langle\nabla\Delta d_p,\nabla d_p\rangle+\langle\Ric(\nabla d_p),\nabla d_p\rangle.\]
    Now we use the geodesic polar coordinate.
    First let $L$ by the corresponding linear transformation of $\nabla^2d_p$, by Proposition~\ref{hess dp in tangential}~and Proposition~\ref{hess dp in other}, we know that $L$ has $n-1$ nonzero eigenvalue, say $\lambda_1,\cdots,\lambda_{n-1}$.
    Then by Cauchy--Schwartz inequality, we have
    \begin{align*}
        |\nabla^2d_p|^2&=\tr(L\circ L)=\sum_{k=1}^{n-1}\lambda^2_k\\
        &\geq\frac{1}{n-1}\left(\sum_{k=1}^{n-1}\lambda_k\right)^2=\frac{1}{n-1}(\tr L)^2\\
        &=\frac{1}{n-1}(\Delta d_p)^2.
    \end{align*}
    Next, we notice that $\nabla d_p=\partial_r$, hence
    \[\langle\nabla\Delta d_p,\nabla d_p\rangle=\langle\partial_r(\Delta d_p)\partial_r,\partial_r\rangle=\frac{\partial(\Delta d_p)}{\partial{r}}.\]
    Moreover, by the assumption, we have
    \[\langle\Ric(\nabla d_p),\nabla d_p\rangle\geq(n-1)K\langle\nabla d_p,\nabla d_p\rangle=(n-1)K.\]
    Add three equalities together, and since $\Delta d_p=\partial_r(\log\mathscr{J})$, we have
    \begin{equation}
        \frac{\partial^2{}}{\partial{r^2}}(\log\mathscr{J})+\frac{1}{n-1}\left(\frac{\partial{}}{\partial{r}}\log\mathscr{J}\right)^2+(n-1)K\leq 0.\label{eq in bishop}
    \end{equation}
    Let $\Phi=\mathscr{J}^{1/(n-1)}$, then the inequality~\eqref{eq in bishop}~is equivalent to
    \[\ddot{\Phi}+K\Phi\leq 0.\]
    However, let $\Phi_K=\mathscr{J}_K^{1/(n-1)}$, we have $\ddot{\Phi}_K+K\Phi_K=0$, and $\Phi_K(0)=\Phi(0)=0, \Phi'_K(0)=\Phi'(0)=1$.
    Then by Sturm--Liouville comparison theorem, we have $\Phi/\Phi_K$ is nonincreasing.
    This derives $\mathscr{J}/\mathscr{J}_K$ is nonincreasing.
\end{proof}

\begin{rem}
    From the original proof of Bishop's theorem, we know it is equivalent to Laplace comparison theorem.
    Hence this argument also gives a new proof of Laplace comparison theorem.
\end{rem}

\section{Spliting Theorem}

\begin{thm}[Cheeger--Gromoll]\label{Cheeger Gromoll}\index{theorem!Cheeger--Gromoll}\index{theorem!splitting}
    Let $M$ be a complete Riemannian manifold with $\Ric\geq 0$.
    Assume $M$ admits a line, that is, there is a unit speed geodesic $\gamma:\mathbb{R}\to M$ such that $d(\gamma(t),\gamma(s))=|t-s|$.
    Then $M$ is isometric to $(\mathbb{R}\times N,g=\d{t^2}+g_N)$.
\end{thm}

\begin{cor}
    Under the same assumption, $M$ is isometric to $\mathbb{R}^k\times N^{n-k}$, where $N^{n-k}$ does not contain any line.
\end{cor}

Before we start the proof, we first state some results from theory of partial differential equations.
\begin{thm}[Mean value property]\index{theorem!mean value property}
    Let $M^n$ be a complete Riemannian manifold with $\Ric\geq 0$.
    If a Lipschitz function $f$ on $M$ satisfies $f\geq 0$, $\Delta f\leq 0$ in distribution sense, then for any $p\in M$ and $R$ sufficiently small, we have
    \[f(p)\geq\frac{1}{\Vol[\mathbb{S}^{n-1}]R^n}\int_{B_R(p)}f\d{\Vol_M},\]
    where $B_R(p)$ is the geodesic ball centered at $p$ with radius $R$.
\end{thm}
\begin{proof}
    See~\cite[Chapter~1.~Proposition~2.1]{Shoen-Yau}.
\end{proof}

\begin{thm}[Weyl's lemma]\index{lemma!Weyl}
    If $f\in W^{2,1}(M)$ satisfies $\Delta f=0$, then $f$ is smooth and harmonic.
\end{thm}
\begin{proof}
    See~\cite[Lemma~2]{Weyl}.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{Cheeger Gromoll}]%
    \footnote{This proof is modified after~\cite[Section~1.2]{Shoen-Yau}.}
    The proof uses the \emph{Busemann function}.
    We first define and discuss some properties of Busemann function.

    Fix $t\in\mathbb{R}$, for $x\in M$, define $b^+_t(x)=d(x,\gamma(t))-t$.
    Then by triangle inequality, if $t_1>t_2$, then
    \[b_{t_1}^+(x)-b_{t_2}^+(x)=d(x,\gamma(t_1))-d(x,\gamma(t_2))-(t_1-t_2)\leq 0,\]
    hence $b_t^+$ is nonincreasing with respective to $t$.
    Moreover, we have $b_t^+(x)\geq-d(x,\gamma(0))$ by triangle inequality, hence $b_t^+$ is bounded below.
    Therefore, for any fixed $x$ the limit $\lim_{t\to+\infty}b^+_t(x)$ exists, and we defined it as $B^+(x)$.
    Similarly we define $b^-_t(x)=d(x,\gamma(-t))-t$, and thus $B^-(x)=\lim_{t\to+\infty}b^-_t(x)$ is well-defined.

    Now we discuss the properties of $B^+$ and $B^-$.
    We first have
    \[B^+(x)+B^-(x)=\lim_{t\to+\infty}(d(x,\gamma(t))+d(x,\gamma(-t))-2t)\geq 0,\]
    and the equality holds when $x\in\gamma(\mathbb{R})$.
    Moreover, by Laplace comparison theorem we have
    \[\Delta b^+_t\leq\frac{n-1}{b^+_t+t},\]
    hence for any test function $\varphi\in C^\infty_c(M)$, $\varphi\geq 0$ we have
    \begin{align*}
        \int_Mb^+_t\Delta\varphi&=\int_M\varphi\Delta b^+_t=\int_M\varphi\Delta d(x,\gamma(t))\\
        &\leq\int_M\varphi\cdot\frac{n-1}{b^+_t+t}.
    \end{align*}
    Let $t\to+\infty$ we have
    \[\int_M\varphi\Delta B^+=\int_M B^+\Delta\varphi\leq 0,\]
    then $\Delta B^+\leq 0$ in weak sense.
    Similarly $\Delta B^-\leq 0$ in weak sense.
    Hence $\Delta(B^++B^-)\leq 0$, $B^++B^-\geq 0$, and $(B^++B^-)(\gamma(t_0))=0$.
    Take the limit of $|b_t^+(x)-b_t^+(y)|\leq d(x,y)$, we obtain that $B^+$ is Lipschitz, so is $B^-$.
    Hence $B^++B^-$ is Lipschitz.
    Then $B^++B^-$ satisfies the assumption of mean value property, that is
    \[(B^++B^-)(p)\geq\frac{1}{\Vol[\mathbb{S}^{n-1}]R^n}\int_{B_R(p)}(B^++B^-)\d{\Vol_{M}}.\]
    Let $p\in\gamma(\mathbb{R})$, we obtain $\Delta(B^++B^-)=0$ in distribution sense.
    Thus $\Delta B^+=\Delta B^-=0$ in distribution sense, by Weyl's lemma $B^+$ and $B^-$ are smooth and harmonic.
    Moreover, since $|\nabla d(x,\gamma(t))|=1$ holds almost everywhere, we have $|B^+|=1$.
    Using Bochner formula, we have
    \[0=\Delta\frac{1}{2}|\nabla B^+|^2=|\nabla^2B^+|^2+\langle\nabla\Delta B^+,\nabla B^+\rangle+\langle\Ric(\nabla B^+),\nabla B^+\rangle\geq|\nabla^2B^+|^2,\]
    hence $\nabla^2B^+=0$.

    Now we come to the geometric part.
    Let $s\in\mathbb{R}$ be a regular value of $B^+$, define $N=\{x\in M|\ B^+(x)=s\}$, then $N$ is a regular submanifold of codimension $1$ by implicit function theorem.
    Now we introduce the map
    \begin{align*}
        f:\mathbb{R}\times N&\to M\\
        (t,p)&\mapsto\exp_{B^+(p)}(t\nabla B^+(p)).
    \end{align*}
    Since $0=\nabla^2B^+=\nabla(\d{B^+})$, $\nabla B^+$ is parallel by the commutativity of musical isomorphism and covariant derivative.
    So we can give $f^{-1}(x)$ of $x\in M$ by taking the integral curve of $\nabla B^+$ passing $x$ and trace back to $N$, ODE theory shows $f^{-1}$ is smooth.
    Therefore $f$ is a diffeomorphism.
    We need to show $f$ induces a product metric on $\mathbb{R}\times N$.
    Let $(U,\varphi)$ be a local chart of $N$, with coordinate $(x^1,\cdots,x^{n-1})$, define the Fermi coordinate $(x^1,\cdots,x^{n-1},t)$ by
    \[(x^1,\cdots,x^{n-1},t)\mapsto\exp_{\varphi^{-1}(x^1,\cdots,x^{n-1})}(t\nabla B^+(\varphi^{-1}(x^1,\cdots,x^{n-1}))).\]
    Then we have
    \[g\left(\frac{\partial{}}{\partial{t}},\frac{\partial{}}{\partial{t}}\right)=|\nabla B^+|^2=1,\]
    and
    \[g\left(\frac{\partial{}}{\partial{t}},\frac{\partial{}}{\partial{x^i}}\right)=g\left(\nabla B^+,\frac{\partial{}}{\partial{x^i}}\right)=0\]
    for $i=1,\cdots,n-1$.
    We need to show $g_{ij}=g(\partial_i,\partial_j)$ is independent from $t$, that is,
    \begin{align*}
        \frac{\partial{}}{\partial{t}}g\left(\frac{\partial{}}{\partial{x^i}},\frac{\partial{}}{\partial{x^j}}\right)=0.
    \end{align*}
    However, since $\nabla B^+$ is parallel, we have
    \begin{align*}
        \frac{\partial{}}{\partial{t}}g\left(\frac{\partial{}}{\partial{x^i}},\frac{\partial{}}{\partial{x^j}}\right)&=g\left(\nabla_{\frac{\partial{}}{\partial{t}}}\frac{\partial{}}{\partial{x^i}},\frac{\partial{}}{\partial{x^j}}\right)+g\left(\nabla_{\frac{\partial{}}{\partial{t}}}\frac{\partial{}}{\partial{x^j}},\frac{\partial{}}{\partial{x^i}}\right)\\
        &=g\left(\nabla_{\frac{\partial{}}{\partial{x^i}}}(\nabla B^+),\frac{\partial{}}{\partial{x^j}}\right)+g\left(\nabla_{\frac{\partial{}}{\partial{x^j}}}(\nabla B^+),\frac{\partial{}}{\partial{x^i}}\right)\\
        &=0.
    \end{align*}
    This finishes our proof.
\end{proof}